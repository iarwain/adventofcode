REBOL [
  Title: {Day 20}
  Date: 20-12-2020
]

data: read %data/20.txt

; --- Part 1 ---
cameras: collect [
  parse data [
    some [
      {Tile } copy id to {:} thru newline (tile: copy [])
      10 [
        [copy line to newline skip | copy line to end] (append tile line)
      ] (keep reduce [id tile])
    | skip
    ]
  ]
]
edges?: funct [tile] [
  left: copy right: copy {}
  foreach line tile [append left first line append right last line]
  collect [
    keep half: reduce [
      copy first tile
      copy last tile
      left
      right
    ]
    foreach edge half [
      keep reverse copy edge
    ]
  ]
]
comment [
edges: collect [
  foreach [id tile] cameras [
    foreach edge edges? tile [
      keep reduce [edge id]
    ]
  ]
]
image: reduce [copy cameras/1 pos: 0x0] total: copy []
c: copy edges
forskip edges 2 [
  count: 0 start: edges edge: edges/1 id: edges/2
  while [start: find start edge] [start: next start count: count + 1]
  if count > 1 [
    start: c
    while [start: find start edge] [remove/part start 2]
  ]
  either find total id [total/:id: total/:id + count] [append total reduce [id count]]
] 2
]
; --- Using corners obtained from C program as it's currently unoptimized for Rebol ---
r1: 2383.0 * 2593 * 2753 * 3881
print [{Part 1:} r1]

; --- Part 2 ---
; --- Using sea image obtained from C program as it's currently unoptimized for Rebol ---
image: {
.#.#.#..#.#..#.........#.....#...#........#...#...#....#.#...............#..###.##....#.........
#...............#...#.#....#.......###..#.....##..##.........#.......#.#.....................#..
#.....................#........#........#....##.#.#..#......#..#..........#...........#.#..#...#
.......#.#..#.#.#...#..#......##.#.#..#.##.#....#......#...#...#.#.......#.......#.....#..#.....
..............##....#..##..............##.......#.#..#...#.....#................#.#....#...#....
#.#.........#......#....#..............#.......#........#...........##......#.......#......###..
......................##...........#.#........###.#....#....#...#....#.#...#.#..#...#.....##..#.
.#.#....##.......#.................##.#..##......#.........#....#.....###.#......##..#.##.#.....
...........#.#.#..#...........#...##.###......##......#..............#.#.....#......#.......#.#.
.#...##............#.......#....#.#.##..#.........#..............##...####.#.###..........#.....
#....#........#...##.....#..#...#..#....#..#.........................#..#....###........#.#.#..#
..........#..#.#.........#.............#...#...#....#..#.#.................####.#..........#.#.#
.##......#.....#....##....##...#..#........#.#..##.##.......#....#....#..#....##.........###...#
..#..##......#......##..#......#...#.......#..............#..#.........#................###.#..#
.....#...#..##..#..##..............#.####.............#.#.###..........#....#......#..##....#...
........#.#........#..#.#...#..#..##...##...#........#....#......#..#.#....#.##...#.............
#....#.#......#.........#...........#...#.#....#.....#...#...........##..#...#.#.....#....#.#...
......#....................#..#.....#.##........#.....#..........#....#...#.##...........#.##...
...#........#....#.#.....#........##.#...............#.......#...#...##........#...........##...
.#.....#.#.#.....#..#.....##.......#.....#.......#......#..#.#...#.....#.#.......#..#.#...#.....
.###..##....###...#.#...#...#.....##...#.......#...#..............#...###...#......#........##..
..#.#...##.....##..#..........#...#....##.##.........#..............#.#.....###...#.#.....#.....
#.......#....#####.#..#..#.....#........#....#....#.#.............#.....###..##.##........##..#.
....#.........##...#...#.......#......###..##.#....#.............#......##..#.#..........###....
...........#..#....##..#.#.......##....#......#........#.#...#........#........#........#.#.....
..........#.......#.#......#...#...#...##.##.#........#...#.#..##.#....#.....#..................
.#.#.........#.....###......#..........#......#.#....#.........###..........#.###........#..##..
#..#.........##....##.....#...#.#.....#....#.#.#...#....#.....#..#....#.....###....#.#.......##.
.....#.#.......#.......###....##.....#...#..#.#.........#...##.....#........##..#.....#.#.....#.
.##....#.......#..#......##..........#...#...#.........#...............#.........#...#..........
...#....#.....#....##..#.#..#..#......#.##.......#..........#.#.........##....#..#.......#......
....#........##.#...#...#...#..#..#....#..#....#....#.............#..#..##.......#.#............
...............#.#.#........#..........#.#.#.#.##.......#.....#.#....###.......................#
..........#...#..#.......#.#..#...##.##........#.....##..#....#...........................#.....
...#....###..#.#.....####.....#.....#.........#.#......#.......#.#........#...............#.....
..#.##..#......#...#.....#....#.........#.........#............#....#....#......#...#....#....#.
#...#.......####........##...#..#.#..###........................#..#............................
........##............#.#.........#..#.#..#...##.........#......#....#.......#.#................
#....#.#...#..#.#.##....##....#......#.#...#...#.#...........#.....#..#.#...#..#........##....#.
...##..#......#.#...#.#...##.#........##..#.##.#.......#.........#.............##........##.....
....##........###.......#.......#...#........##................#.#...........#.#.........#......
##.##...#.....#.....#..#.#.........................................#.#........#....#..#.#.#.....
.###..#......#...#...##..#..#......#.##......#..........##........#....#....#.....#............#
...#......#.............#......#..#..#.#...#..#.#...............#..#.#.#......##.........#....#.
.........#..#.....##.....#.....#.......#..#....#.#..##.#..##..#...##.#.......###.......##.#.....
...#.#.#..........##..#.............#..........##....#...#..#.....#.#..#....#..#.........##.#...
....#.#...............#.#....#.....#..........#..#....#....#.....#......#..##..#........##.....#
..#.#........#.....#....##....#.........#....#.....#...##...#...#...#.....#.###.........#..##...
..##..#.#...................#....#............#...#.#.#..#..##...#..........#...##.#.#..#...#...
.........#..#..........#.........#......#....##............#...#......#........###.......#......
.#...#.....#........#...#......................#............#....##.#....#..#.#.#......##..#.##.
..##..#..##.....##..#.....#......##.#.....#.......#.....#...#....##............#.........#......
....#..#.....##.##....##......##..##..#..##.#....#.............#.#.....#..#....#..#......#.#....
....#.....................#...#.....#...#.....#...#...#....##...#...##....#...##........#......#
...#..................#.#...#.......#.....#..#...###........#...#...........##.#..##.....##.....
...#...#......#.....#..##...............##..#.....##.............#.......#.#..####....#.........
............#.....##...............#....#........#..........#...#..#.....#.#..#........##.#..#..
.#.#..##...#........#......#........#.......#........#...##.#.#..#.#.##.##....##.......#.#......
#...#.#.....###.#.............#.....#..#.........#........#......###....#.........#........#..#.
.....#....#.#....#.##....#.#.#..##.....#...#.#...#..#.....##...##.........#.#..#.#....#...#.#...
....#.........##..........#...#..##.#...#....#....####....#..##.............#......#.........#.#
#..#......#..#.....................#....#.........#......#......#.#.#..#....................#...
....#.....##.........#.....................##....#.#.#....#..#..#....#..#.#.#.#.#.#...#.......##
.###...#..#.......................#.##.#......#....#...#.........#..................#..#.......#
..............#.#..#.##..#.#.........#......#..#..##...#.##......#......#.......#..#.....#......
......#......#.....##.................#.......#.##...#...##.....##..###.#..#..........##...#.#..
.......#.#......#......#.........##...#..#.#..#...#....#..#.....#......#...#....#..#............
.....#.........#.#......##...#.#......#...#.##.#..#......#..#....#........#...#..........#..#...
.#...#...........#.....##........#.....#......##.#....##...#....#..........###...........##....#
....##...#....#.###....#.................#.....#..#......#...#.#.#........#.................#...
#............#......#.#............#........#.#..###...###..#............#.......#...#......##..
......#.....#.#.##...............................##.......#.#........##....#...#.##.........#...
..##..........##.........#..#..##............#..#.#.#.....#........#.........#.#.#..#......###..
#......#......#...##...#.............#................#..#.###...........#....#.#.........#.....
#.........#..##...##.#.....#.#.....#....#..........#.....##...............#...#.................
..............#..#.....#........#..##..............#...........#......#..............#.##.####..
.#.#......#......#.#...............#.........#...#..#.##.#........#......#......##..#.......#...
.#.........###..#.#...........###.#.#..#................#.#..........#..#..#...###.......#.###..
#...#.....#.#.#.##......#.#..............#......#..#..............#...#..#......##..#......#..#.
......#.......##.#...#.#..........#..#........##......#...#.#.........#.........#.......#.#...#.
........#....#.#.#................#.#...#........##.#...##.#.....#.#..#....#.#..#.......#.#.#...
..##...#...#..##.#.......#.........#...........................#..#................#.#..#..#...#
.......##.#...#...#........#.##...##.#.#............#.........#.......#.......#.#......#....#...
.............#..#.##.....###...#..#.....................#....##........#......#..##...#.....#...
....#.........#..............##..#...#...........................#..#........#...#....#...##.##.
#..##.....#...#..#........................##.##.##.#.....##......#...#.......##.#...........###.
..##...#..#.##.....#.#........#...#......#...#.....#..#.....#........##.................#......#
#....#........#.#.................##......#....##.......#...#.#..#.....#..##..#........#...#....
.#...........#.#..##...............#..##.......##.............##.#..#.#..##.....#...........#...
............###.....#...#...#.....#......#...##.......#....#.........#...#.......#..#.#....#....
..##..........#.......#.#.......#........#..#.#..##......#...........#...#......#.#.............
..#...#........................#......#...#....#...............#....#.#..##......#..#...........
..#........................#.....##.........###...#........#.###......#....#.#...#..............
.#............#......#..#..#......##.#..#..#.....#...#...............#.#...........#............
.............#.#....#....#....#..........#......##...........#.#..#.#.....#...#...#...##........
.#......#...#...#....#.............#....................#..#..#........#..##........#..#........
}

transform: funct [image] [
  pos: 0x0 collect [
    parse/all image [
      some [
        newline (pos: as-pair 0 pos/y + 1)
      | [#"#" (keep pos) | skip] (pos: pos + 1x0)
      ]
    ]
  ]
]
sea: transform image
monster: transform {
                  #
#    ##    ##    ###
 #  #  #  #  #  #
}
r2: do funct [] [
  variations: collect [
    foreach op collect [
      foreach flip [1x1 -1x1 -1x-1 1x-1] [
        foreach rotation [[offset] [as-pair offset/y negate offset/x]] [
          keep/only append reduce [flip '*] rotation
        ]
      ]
    ] [keep/only map-each offset map-each pixel next monster [pixel - monster/1] op]
  ]
  until [
    count: 0 offsets: first+ variations
    foreach pixel sea [
      unless foreach offset offsets [
        unless find sea pixel + offset [break/return true]
      ] [count: count + 1]
    ]
    count != 0
  ]
  (length? sea) - (count * length? monster)
]
print [{Part 2:} r2]
